# Alertmanager Configuration ConfigMap
# Defines routing, grouping, and notification receivers

apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: octollm-monitoring
  labels:
    app: alertmanager
    component: monitoring
data:
  alertmanager.yml: |
    global:
      resolve_timeout: 5m
      # Slack webhook URL (configure in production)
      # slack_api_url: 'https://hooks.slack.com/services/YOUR/WEBHOOK/URL'

    # Alert grouping and notification templates
    templates:
    - '/etc/alertmanager/templates/*.tmpl'

    # Routing rules
    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'default'

      # Route based on severity
      routes:
        # Critical alerts → PagerDuty + Slack #critical-alerts
        - match:
            severity: critical
          receiver: 'pagerduty-critical'
          group_wait: 10s
          group_interval: 2m
          repeat_interval: 30m

        # Warning alerts → Slack #alerts
        - match:
            severity: warning
          receiver: 'slack-warnings'
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h

        # Info alerts → Slack #info (optional)
        - match:
            severity: info
          receiver: 'slack-info'
          group_wait: 1m
          group_interval: 10m
          repeat_interval: 12h

    # Inhibition rules (suppress low-severity when high-severity active)
    inhibit_rules:
      # Suppress warning if critical alert active for same alertname
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'namespace', 'service']

      # Suppress info if warning active
      - source_match:
          severity: 'warning'
        target_match:
          severity: 'info'
        equal: ['alertname', 'namespace', 'service']

      # Suppress all alerts if entire service is down
      - source_match:
          alertname: 'ServiceDown'
        target_match_re:
          alertname: '.*'
        equal: ['namespace', 'service']

    # Notification receivers
    receivers:
      # Default receiver (log only)
      - name: 'default'
        # webhook_configs:
        #   - url: 'http://localhost:5001/'

      # PagerDuty for critical alerts (configure in production)
      - name: 'pagerduty-critical'
        # pagerduty_configs:
        #   - service_key: 'YOUR_PAGERDUTY_INTEGRATION_KEY'
        #     description: '{{ .CommonAnnotations.summary }}'
        #     details:
        #       severity: '{{ .CommonLabels.severity }}'
        #       description: '{{ .CommonAnnotations.description }}'
        #       runbook: '{{ .CommonAnnotations.runbook_url }}'

        # Also send to Slack #critical-alerts
        # slack_configs:
        #   - channel: '#critical-alerts'
        #     title: 'CRITICAL: {{ .CommonLabels.alertname }}'
        #     text: '{{ .CommonAnnotations.description }}'
        #     send_resolved: true

      # Slack for warnings
      - name: 'slack-warnings'
        # slack_configs:
        #   - channel: '#alerts'
        #     title: 'WARNING: {{ .CommonLabels.alertname }}'
        #     text: '{{ .CommonAnnotations.description }}'
        #     send_resolved: true

      # Slack for info alerts
      - name: 'slack-info'
        # slack_configs:
        #   - channel: '#info'
        #     title: 'INFO: {{ .CommonLabels.alertname }}'
        #     text: '{{ .CommonAnnotations.description }}'
        #     send_resolved: false
