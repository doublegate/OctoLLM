# Loki Deployment for OctoLLM
# Centralized log aggregation with GCS storage backend
#
# Features:
# - GCS backend for persistent log storage
# - 30-day retention (INFO), 90-day retention (ERROR/WARN)
# - 10MB/s ingestion rate limit
# - Query limits: 5000 lines, 30s timeout

apiVersion: apps/v1
kind: Deployment
metadata:
  name: loki
  namespace: octollm-monitoring
  labels:
    app: loki
    component: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: loki
  template:
    metadata:
      labels:
        app: loki
        component: monitoring
    spec:
      serviceAccountName: loki
      securityContext:
        fsGroup: 10001
        runAsUser: 10001
        runAsNonRoot: true

      containers:
        - name: loki
          image: grafana/loki:2.9.4
          imagePullPolicy: IfNotPresent

          args:
            - '-config.file=/etc/loki/loki.yaml'

          ports:
            - name: http
              containerPort: 3100
              protocol: TCP

          volumeMounts:
            - name: loki-config
              mountPath: /etc/loki/loki.yaml
              subPath: loki.yaml
              readOnly: true

            - name: loki-storage
              mountPath: /loki

          resources:
            requests:
              memory: "512Mi"
              cpu: "200m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          livenessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10

          readinessProbe:
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10

      volumes:
        - name: loki-config
          configMap:
            name: loki-config

        - name: loki-storage
          persistentVolumeClaim:
            claimName: loki-pvc
