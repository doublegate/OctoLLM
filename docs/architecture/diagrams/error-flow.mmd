%% OctoLLM Error Flow & Handling
%% Shows error propagation, retry logic, circuit breakers, and graceful degradation

graph TB
    %% Entry Point
    Request["Client Request"]

    %% Error Sources
    subgraph "Error Sources"
        direction LR
        ValidationError["Validation Error<br/>(400 Bad Request)"]
        AuthError["Authentication Error<br/>(401/403)"]
        RateLimitError["Rate Limit Error<br/>(429)"]
        ArmError["Arm Execution Error<br/>(500/503)"]
        TimeoutError["Timeout Error<br/>(504)"]
        ResourceError["Resource Exhausted<br/>(507)"]
    end

    %% Orchestrator Error Handler
    Orchestrator["Orchestrator<br/>(Error Coordinator)"]

    %% Error Detection & Classification
    subgraph "Error Detection"
        direction TB
        DetectError["Detect Error"]
        ClassifyError["Classify Error Type"]
        DetermineRetry{"Retryable?"}
        DetermineDegrade{"Degradable?"}

        DetectError --> ClassifyError
        ClassifyError --> DetermineRetry
        DetermineRetry -->|"Yes"| RetryLogic
        DetermineRetry -->|"No"| DetermineDegrade
        DetermineDegrade -->|"Yes"| GracefulDegradation
        DetermineDegrade -->|"No"| FatalError
    end

    %% Retry Logic with Exponential Backoff
    subgraph "Retry Logic (Exponential Backoff)"
        direction TB
        RetryLogic["Retry Strategy"]
        Attempt1["Attempt 1<br/>Wait: 0s"]
        Attempt2["Attempt 2<br/>Wait: 1s"]
        Attempt3["Attempt 3<br/>Wait: 2s"]
        Attempt4["Attempt 4<br/>Wait: 4s"]
        MaxRetries{"Max retries<br/>reached?"}

        RetryLogic --> Attempt1
        Attempt1 -.->|"Failed"| Attempt2
        Attempt2 -.->|"Failed"| Attempt3
        Attempt3 -.->|"Failed"| Attempt4
        Attempt4 --> MaxRetries
        MaxRetries -->|"Yes"| FatalError
        MaxRetries -->|"No"| Attempt1
    end

    %% Circuit Breaker Pattern
    subgraph "Circuit Breaker (Per Arm)"
        direction LR
        Closed["Closed<br/>(Normal operation)<br/>Errors: 0-5"]
        HalfOpen["Half-Open<br/>(Testing recovery)<br/>1 test request"]
        Open["Open<br/>(Failing fast)<br/>Wait: 30s"]

        Closed -->|">= 5 errors<br/>in 10s"| Open
        Open -->|"After 30s"| HalfOpen
        HalfOpen -->|"Success"| Closed
        HalfOpen -->|"Failure"| Open
    end

    %% Graceful Degradation Strategies
    subgraph "Graceful Degradation"
        direction TB
        GracefulDegradation["Degradation Strategy"]

        Strategy1["1. Use Cached Result<br/>(Stale data OK)"]
        Strategy2["2. Use Cheaper Arm<br/>(Lower quality OK)"]
        Strategy3["3. Skip Optional Step<br/>(Partial result OK)"]
        Strategy4["4. Return Partial Result<br/>(Best effort)"]

        GracefulDegradation --> Strategy1
        GracefulDegradation --> Strategy2
        GracefulDegradation --> Strategy3
        GracefulDegradation --> Strategy4
    end

    %% Fatal Error Handling
    subgraph "Fatal Error Response"
        direction TB
        FatalError["Fatal Error"]
        LogError["1. Log Error<br/>(with trace ID)"]
        NotifyOps["2. Notify Operations<br/>(if critical)"]
        RollbackState["3. Rollback State<br/>(if needed)"]
        ReturnError["4. Return Error<br/>to Client"]

        FatalError --> LogError
        LogError --> NotifyOps
        NotifyOps --> RollbackState
        RollbackState --> ReturnError
    end

    %% Error Response Format
    subgraph "Error Response Format"
        direction TB
        ErrorResponse["Error Response"]
        ErrorCode["error_code: string"]
        ErrorMessage["message: string"]
        ErrorDetails["details: object"]
        RecoverySuggestions["recovery_suggestions: string[]"]
        TraceID["trace_id: string"]

        ErrorResponse --> ErrorCode
        ErrorResponse --> ErrorMessage
        ErrorResponse --> ErrorDetails
        ErrorResponse --> RecoverySuggestions
        ErrorResponse --> TraceID
    end

    %% Specific Error Flows
    subgraph "Common Error Scenarios"
        direction TB

        %% Scenario 1: Arm Timeout
        ScenarioTimeout["Arm Timeout<br/>(30s limit)"]
        TimeoutRetry{"Retry?"}
        TimeoutFallback["Use cached result<br/>or skip step"]

        ScenarioTimeout --> TimeoutRetry
        TimeoutRetry -->|"Yes (attempt 1-2)"| Attempt1
        TimeoutRetry -->|"No (attempt 3)"| TimeoutFallback

        %% Scenario 2: Validation Failure
        ScenarioValidation["Validation Failure<br/>(Judge rejects output)"]
        ValidationRetry{"Retry?"}
        ValidationRefine["Refine prompt<br/>with feedback"]

        ScenarioValidation --> ValidationRetry
        ValidationRetry -->|"Yes (attempt 1-2)"| ValidationRefine
        ValidationRetry -->|"No (attempt 3)"| FatalError

        %% Scenario 3: Circuit Breaker Open
        ScenarioCircuit["Circuit Breaker Open<br/>(Arm is down)"]
        CircuitFallback["Route to backup arm<br/>or skip step"]

        ScenarioCircuit --> CircuitFallback
        CircuitFallback -.->|"No backup"| FatalError

        %% Scenario 4: Budget Exhausted
        ScenarioBudget["Budget Exhausted<br/>(Tokens/Cost/Time)"]
        BudgetPartial["Return partial result<br/>with warning"]

        ScenarioBudget --> BudgetPartial
    end

    %% Main Error Flow
    Request --> Orchestrator
    Orchestrator -->|"Execute"| Orchestrator
    Orchestrator -.->|"Error occurs"| DetectError

    %% Error Classification
    ValidationError -.-> ClassifyError
    AuthError -.-> ClassifyError
    RateLimitError -.-> ClassifyError
    ArmError -.-> ClassifyError
    TimeoutError -.-> ClassifyError
    ResourceError -.-> ClassifyError

    %% Retry Success/Failure
    Attempt1 -.->|"Success"| Orchestrator
    Attempt2 -.->|"Success"| Orchestrator
    Attempt3 -.->|"Success"| Orchestrator
    Attempt4 -.->|"Success"| Orchestrator

    %% Degradation Success
    Strategy1 -.->|"Degraded success"| Orchestrator
    Strategy2 -.->|"Degraded success"| Orchestrator
    Strategy3 -.->|"Degraded success"| Orchestrator
    Strategy4 -.->|"Degraded success"| Orchestrator

    %% Final Response
    Orchestrator -->|"Success"| SuccessResponse["Success Response<br/>(200 OK)"]
    Orchestrator -.->|"Degraded success"| DegradedResponse["Degraded Response<br/>(200 OK + warnings)"]
    ReturnError -->|"Fatal error"| ErrorResponseFinal["Error Response<br/>(4xx/5xx)"]

    SuccessResponse --> Client["Client"]
    DegradedResponse --> Client
    ErrorResponseFinal --> Client

    %% Observability (Background)
    DetectError -.->|"Log"| ErrorLog[("Error Log<br/>(Loki)")]
    DetectError -.->|"Metric"| ErrorMetric[("Error Metric<br/>(Prometheus)")]
    DetectError -.->|"Trace"| ErrorTrace[("Error Trace<br/>(Jaeger)")]

    %% Styling
    classDef request fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef error fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef orchestrator fill:#f3e5f5,stroke:#4a148c,stroke-width:3px
    classDef retry fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef circuit fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    classDef degrade fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef fatal fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef response fill:#e0f2f1,stroke:#004d40,stroke-width:2px
    classDef observability fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class Request,Client request
    class ValidationError,AuthError,RateLimitError,ArmError,TimeoutError,ResourceError error
    class Orchestrator orchestrator
    class RetryLogic,Attempt1,Attempt2,Attempt3,Attempt4,MaxRetries retry
    class Closed,HalfOpen,Open circuit
    class GracefulDegradation,Strategy1,Strategy2,Strategy3,Strategy4 degrade
    class FatalError,LogError,NotifyOps,RollbackState,ReturnError fatal
    class SuccessResponse,DegradedResponse,ErrorResponseFinal,ErrorResponse,ErrorCode,ErrorMessage,ErrorDetails,RecoverySuggestions,TraceID response
    class ErrorLog,ErrorMetric,ErrorTrace observability

%% Error Flow & Handling Summary:
%%
%% ERROR CLASSIFICATION:
%%
%% RETRYABLE ERRORS (Transient failures):
%% - Timeout (504): Arm took too long, retry with same or different arm
%% - Service Unavailable (503): Arm temporarily down, retry after backoff
%% - Rate Limit (429): Too many requests, retry after wait period
%% - Network errors: Connection refused, DNS failure, etc.
%%
%% NON-RETRYABLE ERRORS (Permanent failures):
%% - Validation Error (400): Invalid request format, malformed JSON
%% - Authentication Error (401): Invalid API key, expired token
%% - Authorization Error (403): Insufficient permissions
%% - Resource Exhausted (507): Budget exceeded (tokens/cost/time)
%% - Arm Capability Mismatch: No arm has required capabilities
%%
%% RETRY STRATEGY (Exponential Backoff):
%% - Attempt 1: Immediate (0s wait)
%% - Attempt 2: 1s wait
%% - Attempt 3: 2s wait
%% - Attempt 4: 4s wait (max)
%% - Max retries: 3
%% - Backoff formula: wait = 2^(attempt-1) seconds
%% - Jitter: Add random 0-500ms to prevent thundering herd
%%
%% CIRCUIT BREAKER PATTERN (Per Arm):
%%
%% CLOSED STATE (Normal operation):
%% - All requests forwarded to arm
%% - Error counter tracks failures
%% - Threshold: >= 5 errors in 10 seconds → Open
%%
%% OPEN STATE (Failing fast):
%% - All requests rejected immediately (no arm call)
%% - Return 503 Service Unavailable
%% - Wait period: 30 seconds
%% - After 30s → Half-Open
%%
%% HALF-OPEN STATE (Testing recovery):
%% - Allow 1 test request through
%% - If success → Closed (arm recovered)
%% - If failure → Open (wait another 30s)
%%
%% GRACEFUL DEGRADATION STRATEGIES:
%%
%% 1. USE CACHED RESULT:
%%    - If cache has stale result (expired but present)
%%    - Return cached result with warning
%%    - Example: "Returning cached result from 15 minutes ago due to arm timeout"
%%
%% 2. USE CHEAPER ARM:
%%    - If primary arm fails (e.g., Coder with GPT-4)
%%    - Fall back to cheaper arm (e.g., GPT-3.5-turbo)
%%    - Lower quality but completes task
%%    - Example: "Used GPT-3.5 instead of GPT-4 due to service unavailability"
%%
%% 3. SKIP OPTIONAL STEP:
%%    - If step is not critical for acceptance criteria
%%    - Skip the step and continue with remaining steps
%%    - Return partial result with warning
%%    - Example: "Skipped test generation due to Coder arm timeout"
%%
%% 4. RETURN PARTIAL RESULT:
%%    - If some steps completed successfully
%%    - Return completed steps + error for failed step
%%    - Best effort: user gets what was possible
%%    - Example: "Retrieved CVE details but failed to generate exploit code"
%%
%% ERROR RESPONSE FORMAT:
%% {
%%   "error": {
%%     "code": "arm_timeout",
%%     "message": "Coder arm timed out after 30 seconds",
%%     "details": {
%%       "arm_id": "coder",
%%       "timeout_seconds": 30,
%%       "step_number": 3
%%     },
%%     "recovery_suggestions": [
%%       "Retry the request (transient failure)",
%%       "Simplify the code generation instruction",
%%       "Increase timeout in request budget"
%%     ],
%%     "trace_id": "trace_abc123xyz789"
%%   },
%%   "status": "failed",
%%   "task_id": "task_abc123"
%% }
%%
%% COMMON ERROR SCENARIOS:
%%
%% SCENARIO 1: ARM TIMEOUT
%% - Arm exceeds 30s timeout
%% - Retry: Attempt 1-2 with exponential backoff
%% - If still fails: Use cached result or skip step
%% - Circuit breaker: 5 consecutive timeouts → Open
%%
%% SCENARIO 2: VALIDATION FAILURE
%% - Judge rejects output (doesn't meet acceptance criteria)
%% - Retry: Refine prompt with Judge's feedback
%% - Max 2 retries with refined prompt
%% - If still fails: Return error to user
%%
%% SCENARIO 3: CIRCUIT BREAKER OPEN
%% - Arm circuit breaker is in Open state
%% - Don't attempt arm call (fail fast)
%% - Route to backup arm if available
%% - If no backup: Return 503 error
%% - Circuit resets after 30s wait period
%%
%% SCENARIO 4: BUDGET EXHAUSTED
%% - Task exceeds budget (tokens, time, or cost)
%% - Non-retryable (intentional limit)
%% - Return partial result with budget exceeded warning
%% - Include: completed steps, used resources, remaining budget
%%
%% ERROR PROPAGATION:
%% - Arm error → Orchestrator → Client
%% - Each layer adds context (arm_id, step_number, trace_id)
%% - Final error includes full context chain
%% - Observability: Log + Metric + Trace at each layer
%%
%% ROLLBACK STRATEGY:
%% - If arm modifies state (e.g., Executor writes file)
%% - On error: Rollback state changes
%% - Transactional operations use database transactions
%% - Non-transactional: Manual rollback with cleanup handlers
%%
%% ALERTING:
%% - Critical errors (auth, arm outage) → Immediate Slack/email
%% - High error rate (>5% in 5 min) → Slack notification
%% - Circuit breaker open → PagerDuty alert
%% - Budget exhausted → No alert (expected)
%%
%% ERROR METRICS:
%% - error_rate (by error_code, arm_id)
%% - retry_count (by error_code)
%% - circuit_breaker_state (by arm_id)
%% - degraded_response_rate
%% - mean_time_to_recovery (MTTR)
