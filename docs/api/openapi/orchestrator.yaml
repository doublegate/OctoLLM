openapi: 3.0.3

info:
  title: OctoLLM Orchestrator API
  description: |
    Central orchestration service for the OctoLLM distributed AI architecture.

    The Orchestrator coordinates task processing across specialized arms, integrating with the
    Reflex Layer for PII/injection detection and PostgreSQL for task persistence.

    ## Features

    - Task submission with automatic safety validation
    - Reflex Layer integration (PII/injection detection)
    - PostgreSQL persistence with async SQLAlchemy
    - Circuit breaker pattern for resilience
    - Prometheus metrics
    - Health/readiness probes

    ## Sprint 1.2 Status

    **Phase 1 Complete**: Reflex Layer Integration
    - ReflexClient with circuit breaker, retry logic
    - 39 tests passing, 97% coverage

    **Phase 2 Complete**: Orchestrator Core
    - FastAPI application with 6 endpoints
    - Database layer (async SQLAlchemy)
    - 87 tests passing, 100% pass rate
    - 85%+ coverage on tested modules

    ## Authentication

    Currently no authentication required (Sprint 1.2).
    Future sprints will implement JWT-based authentication.

    ## Rate Limiting

    Currently no rate limiting (Sprint 1.2).
    Future sprints will implement per-user rate limiting with Redis.

  version: 1.0.0
  contact:
    name: OctoLLM Team
    url: https://github.com/doublegate/OctoLLM
    email: hello@octollm.org
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: http://localhost:8000
    description: Local development
  - url: http://orchestrator:8000
    description: Docker Compose
  - url: https://api.octollm.example.com
    description: Production (future)

tags:
  - name: tasks
    description: Task submission and management
  - name: health
    description: Health and readiness probes for Kubernetes
  - name: metrics
    description: Prometheus metrics
  - name: debug
    description: Debug endpoints (development only)

paths:
  /submit:
    post:
      summary: Submit new task
      description: |
        Submit a task for processing with automatic safety checks via Reflex Layer.

        ## Process Flow

        1. Validates task structure (Pydantic)
        2. Calls Reflex Layer for PII/injection detection
        3. If safe, stores task in PostgreSQL
        4. Returns task_id for status polling

        ## Safety Checks

        - **PII Detection**: 18 patterns (Email, SSN, Credit Card, etc.)
        - **Injection Detection**: 14 OWASP patterns (ignore previous, jailbreak, etc.)
        - Tasks with detected PII/injection are rejected with 400 Bad Request

        ## Performance

        - Latency: ~100-150ms (including Reflex Layer call)
        - Reflex Layer timeout: 10s
        - Circuit breaker: Opens after 5 failures, resets after 60s

      tags:
        - tasks
      operationId: submit_task
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskRequest'
            examples:
              simple_task:
                summary: Simple task (sentiment analysis)
                value:
                  goal: "Analyze the sentiment of this text: I love OctoLLM!"
                  priority: "medium"
              complex_task:
                summary: Complex task with constraints
                value:
                  goal: "Generate a Python script to analyze CSV data"
                  constraints:
                    format: "python"
                    max_lines: 100
                  context: "Data contains sales records from Q4 2024"
                  acceptance_criteria:
                    - "Script must handle missing values"
                    - "Script must output JSON summary"
                    - "Script must include error handling"
                  budget:
                    max_tokens: 5000
                    max_time_seconds: 120
                    max_cost_usd: 0.50
                  priority: "high"
                  metadata:
                    source: "web-app"
                    user_id: "user-123"
              critical_task:
                summary: Critical priority task
                value:
                  goal: "Find and fix security vulnerability in authentication module"
                  constraints:
                    category: "security"
                    severity: "critical"
                  context: "User reported unauthorized access"
                  acceptance_criteria:
                    - "Vulnerability identified and patched"
                    - "Tests added for exploit scenario"
                    - "No breaking changes to API"
                  budget:
                    max_tokens: 10000
                    max_time_seconds: 300
                    max_cost_usd: 1.00
                  priority: "critical"

      responses:
        '202':
          description: Task accepted and queued for processing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskSubmitResponse'
              examples:
                success:
                  summary: Task submitted successfully
                  value:
                    task_id: "123e4567-e89b-12d3-a456-426614174000"
                    status: "pending"
                    message: "Task submitted successfully and queued for processing"

        '400':
          description: Validation error or safety check failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                pii_detected:
                  summary: PII detected in task goal
                  value:
                    error: "Task blocked by security policy"
                    request_id: "req-123e4567"
                    details:
                      pii_detected: true
                      injection_detected: false
                      pii_matches:
                        - pii_type: "Email"
                          value: "user@example.com"
                          position: 42
                          confidence: 0.95
                          context: "Contact me at user@example.com for updates"
                injection_detected:
                  summary: Injection attempt detected
                  value:
                    error: "Task blocked by security policy"
                    request_id: "req-789def01"
                    details:
                      pii_detected: false
                      injection_detected: true
                      injection_matches:
                        - injection_type: "IGNORE_PREVIOUS"
                          severity: "Critical"
                          matched_text: "Ignore all previous instructions"
                          position: 0
                          confidence: 0.98
                          context_analysis:
                            is_quoted: false
                            is_academic: false
                            is_testing: false
                            is_negation: false
                validation_error:
                  summary: Request validation failed
                  value:
                    error: "Validation error"
                    request_id: "req-abc123"
                    details:
                      field: "goal"
                      issue: "Field required"

        '503':
          description: Reflex Layer service unavailable (circuit breaker open)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                circuit_breaker_open:
                  summary: Circuit breaker is open
                  value:
                    error: "Reflex Layer temporarily unavailable (circuit breaker open)"
                    request_id: "req-xyz789"
                    details:
                      circuit_breaker_state: "open"
                      failure_count: 5
                      last_failure_time: "2025-11-15T12:00:00Z"
                service_unavailable:
                  summary: Reflex Layer not responding
                  value:
                    error: "Reflex Layer service unavailable"
                    request_id: "req-def456"
                    details:
                      error_type: "ConnectionError"
                      message: "Failed to connect to http://reflex-layer:8080"

  /tasks/{task_id}:
    get:
      summary: Get task status
      description: |
        Retrieve task status, result, or error by task ID.

        ## Task Statuses

        - **pending**: Task submitted, waiting for processing
        - **processing**: Task currently being executed
        - **completed**: Task completed successfully
        - **failed**: Task execution failed
        - **cancelled**: Task was cancelled (future)

        ## Performance

        - Latency: ~5-10ms (database query)
        - Returns immediately with current status

      tags:
        - tasks
      operationId: get_task
      parameters:
        - name: task_id
          in: path
          required: true
          description: Task UUID (generated at submission)
          schema:
            type: string
            format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"

      responses:
        '200':
          description: Task found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
              examples:
                pending:
                  summary: Task pending (not yet processed)
                  value:
                    task_id: "123e4567-e89b-12d3-a456-426614174000"
                    status: "pending"
                    goal: "Analyze the sentiment of this text: I love OctoLLM!"
                    result: null
                    error: null
                    created_at: "2025-11-15T12:00:00Z"
                    updated_at: "2025-11-15T12:00:00Z"
                    processing_time_ms: null
                completed:
                  summary: Task completed successfully
                  value:
                    task_id: "123e4567-e89b-12d3-a456-426614174000"
                    status: "completed"
                    goal: "Analyze the sentiment of this text: I love OctoLLM!"
                    result:
                      sentiment: "positive"
                      score: 0.95
                      confidence: 0.88
                    error: null
                    created_at: "2025-11-15T12:00:00Z"
                    updated_at: "2025-11-15T12:00:05Z"
                    processing_time_ms: 5234
                failed:
                  summary: Task execution failed
                  value:
                    task_id: "123e4567-e89b-12d3-a456-426614174000"
                    status: "failed"
                    goal: "Generate Python script with invalid constraints"
                    result: null
                    error: "Failed to generate code: Invalid constraint 'format=invalid'"
                    created_at: "2025-11-15T12:00:00Z"
                    updated_at: "2025-11-15T12:00:03Z"
                    processing_time_ms: 3421

        '404':
          description: Task not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                not_found:
                  summary: Task ID does not exist
                  value:
                    error: "Task 999e9999-e99b-99d9-a999-999999999999 not found"
                    request_id: "req-notfound"
                    details: {}

  /health:
    get:
      summary: Health check
      description: |
        Kubernetes liveness probe - checks if service is alive.

        Always returns 200 if the service is running.
        Does NOT check dependencies (database, Reflex Layer).

        Use `/ready` endpoint for readiness checks.

      tags:
        - health
      operationId: health_check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              examples:
                healthy:
                  summary: Service is alive
                  value:
                    status: "healthy"
                    timestamp: "2025-11-15T12:00:00Z"
                    version: "1.0.0"

  /ready:
    get:
      summary: Readiness check
      description: |
        Kubernetes readiness probe - checks if service is ready to accept requests.

        Checks the following dependencies:
        - **PostgreSQL**: Database connection health
        - **Reflex Layer**: Service availability (if enabled)

        Returns 200 only if ALL checks pass.
        Returns 503 if any check fails.

        ## Use Cases

        - Kubernetes readiness probe
        - Load balancer health check
        - Deployment verification

      tags:
        - health
      operationId: readiness_check
      responses:
        '200':
          description: Service is ready to accept requests
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              examples:
                ready:
                  summary: All dependencies healthy
                  value:
                    ready: true
                    checks:
                      database: true
                      reflex_layer: true
                    timestamp: "2025-11-15T12:00:00Z"

        '503':
          description: Service not ready (dependencies unavailable)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
              examples:
                database_down:
                  summary: Database unavailable
                  value:
                    ready: false
                    checks:
                      database: false
                      reflex_layer: true
                    timestamp: "2025-11-15T12:00:00Z"
                reflex_down:
                  summary: Reflex Layer unavailable
                  value:
                    ready: false
                    checks:
                      database: true
                      reflex_layer: false
                    timestamp: "2025-11-15T12:00:00Z"

  /metrics:
    get:
      summary: Prometheus metrics
      description: |
        Prometheus metrics endpoint in text exposition format.

        ## Metrics Exported

        - `orchestrator_tasks_submitted_total`: Counter of tasks submitted (by priority)
        - `orchestrator_task_status_total`: Counter of tasks by status
        - `orchestrator_task_processing_seconds`: Histogram of processing time
        - `orchestrator_http_request_duration_seconds`: Histogram of HTTP request duration
        - `orchestrator_reflex_calls_total`: Counter of Reflex Layer calls (by status)

        ## Example Queries

        **Task submission rate**:
        ```promql
        rate(orchestrator_tasks_submitted_total[5m])
        ```

        **95th percentile processing time**:
        ```promql
        histogram_quantile(0.95, rate(orchestrator_task_processing_seconds_bucket[5m]))
        ```

      tags:
        - metrics
      operationId: get_metrics
      responses:
        '200':
          description: Metrics exported in Prometheus format
          content:
            text/plain:
              schema:
                type: string
              example: |
                # TYPE orchestrator_tasks_submitted_total counter
                orchestrator_tasks_submitted_total{priority="low"} 15.0
                orchestrator_tasks_submitted_total{priority="medium"} 42.0
                orchestrator_tasks_submitted_total{priority="high"} 28.0
                orchestrator_tasks_submitted_total{priority="critical"} 5.0

                # TYPE orchestrator_task_status_total counter
                orchestrator_task_status_total{status="pending"} 10.0
                orchestrator_task_status_total{status="processing"} 3.0
                orchestrator_task_status_total{status="completed"} 65.0
                orchestrator_task_status_total{status="failed"} 12.0

                # TYPE orchestrator_task_processing_seconds histogram
                orchestrator_task_processing_seconds_bucket{le="0.1"} 5.0
                orchestrator_task_processing_seconds_bucket{le="0.5"} 20.0
                orchestrator_task_processing_seconds_bucket{le="1.0"} 40.0
                orchestrator_task_processing_seconds_bucket{le="5.0"} 75.0
                orchestrator_task_processing_seconds_bucket{le="10.0"} 85.0
                orchestrator_task_processing_seconds_sum 245.5
                orchestrator_task_processing_seconds_count 90.0

  /:
    get:
      summary: Root endpoint
      description: |
        Root endpoint providing service information and API navigation links.

        Returns service metadata and links to other endpoints.

      operationId: root
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootResponse'
              examples:
                root:
                  summary: Service info
                  value:
                    service: "OctoLLM Orchestrator"
                    version: "1.0.0"
                    docs: "/docs"
                    health: "/health"
                    ready: "/ready"
                    metrics: "/metrics"

  /debug/stats:
    get:
      summary: Debug statistics
      description: |
        Debug statistics endpoint (development mode only).

        Returns:
        - Task counts by status
        - Reflex Layer client metrics

        **Note**: Only available when `ORCHESTRATOR_DEBUG=true`

      tags:
        - debug
      operationId: debug_stats
      responses:
        '200':
          description: Debug statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DebugStatsResponse'
              examples:
                stats:
                  summary: Current statistics
                  value:
                    task_counts:
                      pending: 5
                      processing: 2
                      completed: 42
                      failed: 3
                      cancelled: 0
                    reflex_metrics:
                      total_requests: 50
                      successful_requests: 47
                      failed_requests: 3
                      blocked_requests: 2
                      pii_detections: 1
                      injection_detections: 1
                      cache_hits: 15
                      total_latency_ms: 4250.5
                      average_latency_ms: 85.01
                      success_rate: 0.94
                      circuit_breaker_state: "closed"
                      circuit_breaker_failure_count: 0

components:
  schemas:
    # ==============================================================================
    # Request Models
    # ==============================================================================

    TaskRequest:
      type: object
      required:
        - goal
      properties:
        goal:
          type: string
          description: Natural language task description
          minLength: 1
          maxLength: 10000
          example: "Analyze the sentiment of this text: I love OctoLLM!"

        constraints:
          type: object
          description: Task-specific constraints (format, length, etc.)
          additionalProperties: true
          example:
            format: "json"
            max_length: 1000

        context:
          type: string
          description: Background information for task execution
          maxLength: 50000
          nullable: true
          example: "User feedback analysis for product reviews"

        acceptance_criteria:
          type: array
          description: Conditions for successful task completion
          items:
            type: string
          example:
            - "Response must be valid JSON"
            - "Response must include sentiment score"

        budget:
          $ref: '#/components/schemas/ResourceBudget'

        priority:
          $ref: '#/components/schemas/Priority'

        metadata:
          type: object
          description: Additional metadata (source, user_id, etc.)
          additionalProperties: true
          example:
            source: "web-app"
            user_id: "user-123"

    ResourceBudget:
      type: object
      description: Resource constraints for task execution
      properties:
        max_tokens:
          type: integer
          description: Maximum LLM tokens to use
          minimum: 1
          maximum: 100000
          default: 10000
          example: 5000

        max_time_seconds:
          type: integer
          description: Maximum execution time in seconds
          minimum: 1
          maximum: 3600
          default: 300
          example: 120

        max_cost_usd:
          type: number
          format: float
          description: Maximum cost in USD
          minimum: 0.0
          maximum: 100.0
          default: 1.0
          example: 0.50

    # ==============================================================================
    # Response Models
    # ==============================================================================

    TaskSubmitResponse:
      type: object
      required:
        - task_id
        - status
        - message
      properties:
        task_id:
          type: string
          format: uuid
          description: Assigned task identifier (UUID v4)
          example: "123e4567-e89b-12d3-a456-426614174000"

        status:
          $ref: '#/components/schemas/TaskStatus'

        message:
          type: string
          description: Confirmation message
          example: "Task submitted successfully and queued for processing"

    TaskResponse:
      type: object
      required:
        - task_id
        - status
        - goal
        - created_at
        - updated_at
      properties:
        task_id:
          type: string
          format: uuid
          description: Task identifier
          example: "123e4567-e89b-12d3-a456-426614174000"

        status:
          $ref: '#/components/schemas/TaskStatus'

        goal:
          type: string
          description: Task goal (natural language)
          example: "Analyze the sentiment of this text: I love OctoLLM!"

        result:
          type: object
          description: Task execution result (if completed)
          nullable: true
          additionalProperties: true
          example:
            sentiment: "positive"
            score: 0.95
            confidence: 0.88

        error:
          type: string
          description: Error message (if failed)
          nullable: true
          example: "Failed to process: Invalid input format"

        created_at:
          type: string
          format: date-time
          description: Task creation timestamp (ISO 8601)
          example: "2025-11-15T12:00:00Z"

        updated_at:
          type: string
          format: date-time
          description: Last update timestamp (ISO 8601)
          example: "2025-11-15T12:00:05Z"

        processing_time_ms:
          type: integer
          description: Total processing time in milliseconds
          nullable: true
          example: 5234

    HealthResponse:
      type: object
      required:
        - status
        - timestamp
        - version
      properties:
        status:
          type: string
          description: Health status
          enum: ["healthy"]
          example: "healthy"

        timestamp:
          type: string
          format: date-time
          description: Check timestamp (ISO 8601)
          example: "2025-11-15T12:00:00Z"

        version:
          type: string
          description: Service version
          example: "1.0.0"

    ReadinessResponse:
      type: object
      required:
        - ready
        - checks
        - timestamp
      properties:
        ready:
          type: boolean
          description: Overall readiness status
          example: true

        checks:
          type: object
          description: Individual component health checks
          required:
            - database
            - reflex_layer
          properties:
            database:
              type: boolean
              description: PostgreSQL connection healthy
              example: true

            reflex_layer:
              type: boolean
              description: Reflex Layer service available
              example: true

        timestamp:
          type: string
          format: date-time
          description: Check timestamp (ISO 8601)
          example: "2025-11-15T12:00:00Z"

    RootResponse:
      type: object
      required:
        - service
        - version
        - docs
        - health
        - ready
        - metrics
      properties:
        service:
          type: string
          description: Service name
          example: "OctoLLM Orchestrator"

        version:
          type: string
          description: Service version
          example: "1.0.0"

        docs:
          type: string
          description: OpenAPI documentation URL
          example: "/docs"

        health:
          type: string
          description: Health check endpoint
          example: "/health"

        ready:
          type: string
          description: Readiness check endpoint
          example: "/ready"

        metrics:
          type: string
          description: Prometheus metrics endpoint
          example: "/metrics"

    DebugStatsResponse:
      type: object
      description: Debug statistics (development mode only)
      properties:
        task_counts:
          type: object
          description: Task counts by status
          additionalProperties:
            type: integer
          example:
            pending: 5
            processing: 2
            completed: 42
            failed: 3

        reflex_metrics:
          type: object
          description: Reflex Layer client metrics
          properties:
            total_requests:
              type: integer
              example: 50
            successful_requests:
              type: integer
              example: 47
            failed_requests:
              type: integer
              example: 3
            blocked_requests:
              type: integer
              example: 2
            pii_detections:
              type: integer
              example: 1
            injection_detections:
              type: integer
              example: 1
            cache_hits:
              type: integer
              example: 15
            total_latency_ms:
              type: number
              example: 4250.5
            average_latency_ms:
              type: number
              example: 85.01
            success_rate:
              type: number
              example: 0.94
            circuit_breaker_state:
              type: string
              enum: ["closed", "open", "half-open"]
              example: "closed"
            circuit_breaker_failure_count:
              type: integer
              example: 0

    ErrorResponse:
      type: object
      required:
        - error
        - request_id
      properties:
        error:
          type: string
          description: Error message
          example: "Task blocked by security policy"

        request_id:
          type: string
          description: Request identifier for debugging
          example: "req-123e4567"

        details:
          type: object
          description: Additional error details
          additionalProperties: true
          example:
            pii_detected: true
            pii_matches:
              - pii_type: "Email"
                value: "user@example.com"
                position: 42
                confidence: 0.95

    # ==============================================================================
    # Enums
    # ==============================================================================

    TaskStatus:
      type: string
      description: Task execution status
      enum:
        - pending
        - processing
        - completed
        - failed
        - cancelled
      example: "pending"

    Priority:
      type: string
      description: Task priority level
      enum:
        - low
        - medium
        - high
        - critical
      default: medium
      example: "medium"

  # ==============================================================================
  # Security Schemes (Future)
  # ==============================================================================

  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT-based authentication (future implementation).

        Obtain token via authentication endpoint.
        Include in Authorization header: `Bearer <token>`

# ==============================================================================
# Security (Future)
# ==============================================================================

# security:
#   - BearerAuth: []

# ==============================================================================
# External Documentation
# ==============================================================================

externalDocs:
  description: OctoLLM Orchestrator Documentation
  url: https://github.com/doublegate/OctoLLM/blob/main/docs/components/orchestrator.md
